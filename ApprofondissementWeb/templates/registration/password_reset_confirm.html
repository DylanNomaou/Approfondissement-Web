{% extends "registration/base_auth.html" %}

{% block title %}Nouveau mot de passe - RestoPLus{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-4">
            <div class="card shadow-lg border-0 rounded-3">
                <div class="card-header bg-success text-white text-center py-4">
                    <h3 class="mb-0">
                        <i class="bi bi-shield-check me-2"></i>
                        Nouveau mot de passe
                    </h3>
                    <p class="mb-0 mt-2 opacity-75">Définissez votre nouveau mot de passe</p>
                </div>
                <div class="card-body p-4">
                    <!-- Messages d'information/erreur -->
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}

                    <div class="mb-4">
                        <p class="text-muted">
                            <i class="bi bi-check-circle text-success me-1"></i>
                            Code validé avec succès ! Choisissez maintenant votre nouveau mot de passe.
                        </p>
                    </div>

                    <form method="post" novalidate>
                        {% csrf_token %}

                        <div class="mb-3">
                            <label for="password1" class="form-label fw-semibold">
                                <i class="bi bi-lock me-1"></i>
                                Nouveau mot de passe
                            </label>
                            <div class="input-group">
                                <input 
                                    type="password" 
                                    class="form-control form-control-lg" 
                                    id="password1" 
                                    name="password1" 
                                    placeholder="Votre nouveau mot de passe"
                                    minlength="8"
                                    required
                                    autocomplete="new-password"
                                >
                                <button class="btn btn-outline-secondary" type="button" id="togglePassword1">
                                    <i class="bi bi-eye" id="eyeIcon1"></i>
                                </button>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="password2" class="form-label fw-semibold">
                                <i class="bi bi-lock-fill me-1"></i>
                                Confirmer le mot de passe
                            </label>
                            <div class="input-group">
                                <input 
                                    type="password" 
                                    class="form-control form-control-lg" 
                                    id="password2" 
                                    name="password2" 
                                    placeholder="Confirmez votre mot de passe"
                                    minlength="8"
                                    required
                                    autocomplete="new-password"
                                >
                                <button class="btn btn-outline-secondary" type="button" id="togglePassword2">
                                    <i class="bi bi-eye" id="eyeIcon2"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Indicateur de force du mot de passe -->
                        <div class="mb-4">
                            <div class="small text-muted mb-2">Force du mot de passe :</div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar" id="passwordStrength" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div id="passwordFeedback" class="form-text"></div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="bi bi-check2-circle me-2"></i>
                                Mettre à jour le mot de passe
                            </button>
                        </div>
                    </form>

                    <hr class="my-4">

                    <div class="text-center">
                        <p class="mb-0">
                            <a href="{% url 'login' %}" class="text-decoration-none">
                                <i class="bi bi-arrow-left me-1"></i>
                                Retour à la connexion
                            </a>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Exigences du mot de passe -->
            <div class="card mt-3 border-0 bg-light">
                <div class="card-body p-3">
                    <h6 class="card-title">
                        <i class="bi bi-info-circle me-1"></i>
                        Exigences du mot de passe
                    </h6>
                    <ul class="list-unstyled mb-0 small" id="passwordRequirements">
                        <li id="req-length"><i class="bi bi-x text-danger me-1"></i> Au moins 8 caractères</li>
                        <li id="req-uppercase"><i class="bi bi-x text-danger me-1"></i> Une lettre majuscule</li>
                        <li id="req-lowercase"><i class="bi bi-x text-danger me-1"></i> Une lettre minuscule</li>
                        <li id="req-number"><i class="bi bi-x text-danger me-1"></i> Un chiffre</li>
                        <li id="req-special"><i class="bi bi-x text-danger me-1"></i> Un caractère spécial</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const password1 = document.getElementById('password1');
    const password2 = document.getElementById('password2');
    const togglePassword1 = document.getElementById('togglePassword1');
    const togglePassword2 = document.getElementById('togglePassword2');
    const eyeIcon1 = document.getElementById('eyeIcon1');
    const eyeIcon2 = document.getElementById('eyeIcon2');
    const passwordStrength = document.getElementById('passwordStrength');
    const passwordFeedback = document.getElementById('passwordFeedback');
    
    // Focus automatique
    password1.focus();
    
    // Toggle visibilité mot de passe
    togglePassword1.addEventListener('click', function() {
        const type = password1.type === 'password' ? 'text' : 'password';
        password1.type = type;
        eyeIcon1.className = type === 'password' ? 'bi bi-eye' : 'bi bi-eye-slash';
    });
    
    togglePassword2.addEventListener('click', function() {
        const type = password2.type === 'password' ? 'text' : 'password';
        password2.type = type;
        eyeIcon2.className = type === 'password' ? 'bi bi-eye' : 'bi bi-eye-slash';
    });
    
    // Vérification de la force du mot de passe
    function checkPasswordStrength(password) {
        let score = 0;
        let feedback = '';
        
        // Réinitialiser les exigences
        const requirements = document.querySelectorAll('#passwordRequirements li');
        requirements.forEach(req => {
            const icon = req.querySelector('i');
            icon.className = 'bi bi-x text-danger me-1';
        });
        
        if (password.length >= 8) {
            score += 20;
            document.querySelector('#req-length i').className = 'bi bi-check text-success me-1';
        }
        if (/[A-Z]/.test(password)) {
            score += 20;
            document.querySelector('#req-uppercase i').className = 'bi bi-check text-success me-1';
        }
        if (/[a-z]/.test(password)) {
            score += 20;
            document.querySelector('#req-lowercase i').className = 'bi bi-check text-success me-1';
        }
        if (/[0-9]/.test(password)) {
            score += 20;
            document.querySelector('#req-number i').className = 'bi bi-check text-success me-1';
        }
        if (/[^A-Za-z0-9]/.test(password)) {
            score += 20;
            document.querySelector('#req-special i').className = 'bi bi-check text-success me-1';
        }
        
        // Mettre à jour la barre de progression
        passwordStrength.style.width = score + '%';
        
        if (score < 40) {
            passwordStrength.className = 'progress-bar bg-danger';
            feedback = 'Faible';
        } else if (score < 80) {
            passwordStrength.className = 'progress-bar bg-warning';
            feedback = 'Moyen';
        } else {
            passwordStrength.className = 'progress-bar bg-success';
            feedback = 'Fort';
        }
        
        passwordFeedback.textContent = feedback;
    }
    
    // Vérification en temps réel
    password1.addEventListener('input', function() {
        checkPasswordStrength(this.value);
        checkPasswordMatch();
    });
    
    password2.addEventListener('input', checkPasswordMatch);
    
    function checkPasswordMatch() {
        if (password2.value && password1.value !== password2.value) {
            password2.setCustomValidity('Les mots de passe ne correspondent pas');
            password2.classList.add('is-invalid');
        } else {
            password2.setCustomValidity('');
            password2.classList.remove('is-invalid');
        }
    }
    
    // Validation du formulaire
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        const pwd1 = password1.value;
        const pwd2 = password2.value;
        
        if (!pwd1 || !pwd2) {
            e.preventDefault();
            alert('Veuillez remplir tous les champs.');
            return;
        }
        
        if (pwd1 !== pwd2) {
            e.preventDefault();
            alert('Les mots de passe ne correspondent pas.');
            password2.focus();
            return;
        }
        
        if (pwd1.length < 8) {
            e.preventDefault();
            alert('Le mot de passe doit contenir au moins 8 caractères.');
            password1.focus();
            return;
        }
    });
});
</script>
{% endblock %}