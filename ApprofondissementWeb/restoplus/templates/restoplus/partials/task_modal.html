{% load static %}

<!-- Modal pour Ajouter une T√¢che -->
<div class="modal fade" id="addTaskModal" tabindex="-1" aria-labelledby="addTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addTaskModalLabel">
                    <i class="bi bi-plus-circle me-2"></i>
                    Ajouter une nouvelle t√¢che
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <form id="addTaskForm" method="post" action="{% url 'accueil' %}" novalidate>
                    {% csrf_token %}
                    
                    <div class="row">
                        <!-- Titre de la t√¢che -->
                        <div class="col-md-8 mb-3">
                            <label for="id_title" class="form-label fw-semibold">
                                <i class="bi bi-pencil me-1 text-primary"></i>
                                Titre de la t√¢che
                                <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="id_title" name="title" required>
                        </div>
                        </div>
                        
                        <!-- Priorit√© -->
                        <div class="col-md-4 mb-3">
                            <label for="{{ task_form.priority.id_for_label }}" class="form-label fw-semibold">
                                <i class="bi bi-flag me-1 text-warning"></i>
                                {{ task_form.priority.label }}
                                <span class="text-danger">*</span>
                            </label>
                            {{ task_form.priority }}
                            {% if task_form.priority.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ task_form.priority.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row">
                        <!-- Cat√©gorie -->
                        <div class="col-md-6 mb-3">
                            <label for="{{ task_form.category.id_for_label }}" class="form-label fw-semibold">
                                <i class="bi bi-tags me-1 text-info"></i>
                                {{ task_form.category.label }}
                                <span class="text-danger">*</span>
                            </label>
                            {{ task_form.category }}
                            {% if task_form.category.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ task_form.category.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Date d'√©ch√©ance -->
                        <div class="col-md-6 mb-3">
                            <label for="{{ task_form.due_date.id_for_label }}" class="form-label fw-semibold">
                                <i class="bi bi-calendar-event me-1 text-success"></i>
                                {{ task_form.due_date.label }}
                                <span class="text-danger">*</span>
                            </label>
                            {{ task_form.due_date }}
                            {% if task_form.due_date.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ task_form.due_date.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Description -->
                    <div class="mb-3">
                        <label for="{{ task_form.description.id_for_label }}" class="form-label fw-semibold">
                            <i class="bi bi-card-text me-1 text-secondary"></i>
                            {{ task_form.description.label }}
                            <span class="text-danger">*</span>
                        </label>
                        {{ task_form.description }}
                        {% if task_form.description.errors %}
                            <div class="invalid-feedback d-block">
                                {{ task_form.description.errors.0 }}
                            </div>
                        {% endif %}
                        <div class="form-text">
                            <small class="text-muted">
                                <span id="charCount">0</span>/500 caract√®res
                            </small>
                        </div>
                    </div>
                    
                    <div class="row">
                        <!-- Assign√© √† -->
                        <div class="col-md-6 mb-3">
                            <label for="{{ task_form.assigned_to.id_for_label }}" class="form-label fw-semibold">
                                <i class="bi bi-person me-1 text-primary"></i>
                                {{ task_form.assigned_to.label }}
                                <span class="text-danger">*</span>
                            </label>
                            {{ task_form.assigned_to }}
                            {% if task_form.assigned_to.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ task_form.assigned_to.errors.0 }}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                <small class="text-muted">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Maintenez Ctrl (ou Cmd sur Mac) pour s√©lectionner plusieurs personnes
                                </small>
                            </div>
                        </div>
                        
                        <!-- Dur√©e estim√©e -->
                        <div class="col-md-6 mb-3">
                            <label for="{{ task_form.estimated_duration.id_for_label }}" class="form-label fw-semibold">
                                <i class="bi bi-clock me-1 text-warning"></i>
                                {{ task_form.estimated_duration.label }}
                            </label>
                            {{ task_form.estimated_duration }}
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary btn-lg" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>
                    Annuler
                </button>
                <button type="submit" form="addTaskForm" class="btn btn-primary btn-lg">
                    <i class="bi bi-check-circle me-2"></i>
                    Cr√©er la t√¢che
                </button>
            </div>
        </div>
    </div>
</div>
                                </option>
                                <option value="urgent">
                                    <i class="bi bi-exclamation-triangle text-danger"></i>
                                    Urgente
                                </option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <!-- Cat√©gorie -->
                        <div class="col-md-6 mb-3">
                            <label for="taskCategory" class="form-label fw-semibold">
                                <i class="bi bi-tags me-1 text-info"></i>
                                Cat√©gorie
                            </label>
                            <select class="form-select form-select-lg" id="taskCategory" name="category">
                                <option value="">S√©lectionner une cat√©gorie</option>
                                <option value="kitchen">üç≥ Cuisine</option>
                                <option value="service">üçΩÔ∏è Service</option>
                                <option value="inventory">üì¶ Inventaire</option>
                                <option value="cleaning">üßΩ Nettoyage</option>
                                <option value="admin">üìã Administration</option>
                                <option value="maintenance">üîß Maintenance</option>
                                <option value="training">üìö Formation</option>
                                <option value="other">üîó Autre</option>
                            </select>
                        </div>
                        
                        <!-- Date d'√©ch√©ance -->
                        <div class="col-md-6 mb-3">
                            <label for="taskDueDate" class="form-label fw-semibold">
                                <i class="bi bi-calendar-event me-1 text-success"></i>
                                Date d'√©ch√©ance
                            </label>
                            <input type="datetime-local" class="form-control form-control-lg" 
                                   id="taskDueDate" name="due_date">
                        </div>
                    </div>
                    
                    <!-- Description -->
                    <div class="mb-3">
                        <label for="taskDescription" class="form-label fw-semibold">
                            <i class="bi bi-card-text me-1 text-secondary"></i>
                            Description d√©taill√©e
                        </label>
                        <textarea class="form-control" id="taskDescription" name="description" 
                                  rows="4" maxlength="500"
                                  placeholder="D√©crivez la t√¢che en d√©tail, les √©tapes √† suivre, les ressources n√©cessaires..."></textarea>
                        <div class="form-text">
                            <small class="text-muted">
                                <span id="charCount">0</span>/500 caract√®res
                            </small>
                        </div>
                    </div>
                    
                    <div class="row">
                        <!-- Assign√© √† -->
                        <div class="col-md-6 mb-3">
                            <label for="taskAssignee" class="form-label fw-semibold">
                                <i class="bi bi-person me-1 text-primary"></i>
                                Assign√© √†
                            </label>
                            <select class="form-select form-select-lg" id="taskAssignee" name="assignee">
                                <option value="">S√©lectionner un employ√©</option>
                                <option value="me">üë§ Moi-m√™me</option>
                                <option value="chef">üë®‚Äçüç≥ Chef de cuisine</option>
                                <option value="waiter1">üçΩÔ∏è Serveur 1</option>
                                <option value="waiter2">üçΩÔ∏è Serveur 2</option>
                                <option value="cleaner">üßΩ Agent d'entretien</option>
                                <option value="manager">üëî Manager</option>
                            </select>
                        </div>
                        
                        <!-- Dur√©e estim√©e -->
                        <div class="col-md-6 mb-3">
                            <label for="taskDuration" class="form-label fw-semibold">
                                <i class="bi bi-clock me-1 text-warning"></i>
                                Dur√©e estim√©e
                            </label>
                            <select class="form-select form-select-lg" id="taskDuration" name="estimated_duration">
                                <option value="">Estimer la dur√©e</option>
                                <option value="15">15 minutes</option>
                                <option value="30">30 minutes</option>
                                <option value="60">1 heure</option>
                                <option value="120">2 heures</option>
                                <option value="240">4 heures</option>
                                <option value="480">8 heures (journ√©e compl√®te)</option>
                                <option value="custom">Dur√©e personnalis√©e</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Options additionnelles -->
                    <div class="row">
                        <div class="col-12 mb-3">
                            <div class="form-check-container">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="taskRecurring" name="is_recurring">
                                    <label class="form-check-label fw-medium" for="taskRecurring">
                                        <i class="bi bi-arrow-repeat me-1 text-info"></i>
                                        T√¢che r√©currente
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="taskUrgent" name="is_urgent">
                                    <label class="form-check-label fw-medium" for="taskUrgent">
                                        <i class="bi bi-exclamation-triangle me-1 text-danger"></i>
                                        Marquer comme urgent
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="taskNotification" name="send_notification" checked>
                                    <label class="form-check-label fw-medium" for="taskNotification">
                                        <i class="bi bi-bell me-1 text-primary"></i>
                                        Envoyer notification
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary btn-lg" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>
                    Annuler
                </button>
                <button type="submit" form="addTaskForm" class="btn btn-primary btn-lg">
                    <i class="bi bi-check-circle me-2"></i>
                    Cr√©er la t√¢che
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* Styles pour les champs d'erreur */
.form-control.is-invalid,
.form-select.is-invalid {
    border-color: #dc3545 !important;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
}

/* Message d'erreur sous les champs */
.invalid-feedback {
    display: block !important;
    width: 100%;
    margin-top: 0.25rem;
    font-size: 0.875rem;
    color: #dc3545;
    font-weight: 500;
}

/* Ast√©risque rouge pour les champs obligatoires */
.text-danger {
    color: #dc3545 !important;
    font-weight: bold;
}

/* Animation pour les champs d'erreur */
.form-control.is-invalid,
.form-select.is-invalid {
    animation: shake 0.5s ease-in-out;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}

/* Style pour les labels des champs obligatoires */
.form-label .text-danger {
    margin-left: 2px;
}

/* Am√©lioration visuelle des messages d'erreur */
.invalid-feedback {
    background: linear-gradient(90deg, rgba(220, 53, 69, 0.1), transparent);
    padding: 0.375rem 0.75rem;
    border-radius: 0.25rem;
    border-left: 3px solid #dc3545;
    margin-top: 0.5rem;
}

.invalid-feedback::before {
    content: "‚ö†Ô∏è ";
    margin-right: 0.25rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gestion du compteur de caract√®res
    const taskDescription = document.getElementById('taskDescription');
    const charCount = document.getElementById('charCount');
    
    if (taskDescription && charCount) {
        taskDescription.addEventListener('input', function() {
            charCount.textContent = this.value.length;
            if (this.value.length > 450) {
                charCount.className = 'text-warning fw-bold';
            } else if (this.value.length > 480) {
                charCount.className = 'text-danger fw-bold';
            } else {
                charCount.className = 'text-muted';
            }
        });
    }
    
    // Auto-fill de la date d'√©ch√©ance (demain par d√©faut)
    const dueDateInput = document.getElementById('taskDueDate');
    if (dueDateInput && !dueDateInput.value) {
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        dueDateInput.value = tomorrow.toISOString().split('T')[0];
    }
    
    // Validation en temps r√©el
    const fieldsToValidate = [
        'taskTitle', 'taskPriority', 'taskCategory', 
        'taskDescription', 'taskDueDate', 'taskAssignee'
    ];
    
    fieldsToValidate.forEach(function(fieldId) {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('input', function() {
                this.classList.remove('is-invalid');
            });
            
            field.addEventListener('blur', function() {
                if (this.hasAttribute('required') && this.value.trim() === '') {
                    this.classList.add('is-invalid');
                }
            });
        }
    });
});
</script>
