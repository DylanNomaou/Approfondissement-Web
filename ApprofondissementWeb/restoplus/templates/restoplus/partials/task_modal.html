{% load static %}

<!-- Modal pour Ajouter une T√¢che -->
<div class="modal fade" id="addTaskModal" tabindex="-1" aria-labelledby="addTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addTaskModalLabel">
                    <i class="bi bi-plus-circle me-2"></i>
                    Ajouter une nouvelle t√¢che
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <form id="addTaskForm" method="post" action="#" novalidate>
                    {% csrf_token %}
                    
                    <div class="row">
                        <!-- Titre de la t√¢che -->
                        <div class="col-md-8 mb-3">
                            <label for="taskTitle" class="form-label fw-semibold">
                                <i class="bi bi-pencil me-1 text-primary"></i>
                                Titre de la t√¢che
                                <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control form-control-lg" id="taskTitle" name="title" 
                                   placeholder="Ex: V√©rifier les stocks frigo..." required maxlength="100">
                            <div class="invalid-feedback">
                                Veuillez saisir un titre pour la t√¢che.
                            </div>
                        </div>
                        
                        <!-- Priorit√© -->
                        <div class="col-md-4 mb-3">
                            <label for="taskPriority" class="form-label fw-semibold">
                                <i class="bi bi-flag me-1 text-warning"></i>
                                Priorit√©
                            </label>
                            <select class="form-select form-select-lg" id="taskPriority" name="priority">
                                <option value="low">
                                    <i class="bi bi-circle text-success"></i>
                                    Faible
                                </option>
                                <option value="medium" selected>
                                    <i class="bi bi-circle text-warning"></i>
                                    Moyenne
                                </option>
                                <option value="high">
                                    <i class="bi bi-circle text-danger"></i>
                                    √âlev√©e
                                </option>
                                <option value="urgent">
                                    <i class="bi bi-exclamation-triangle text-danger"></i>
                                    Urgente
                                </option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <!-- Cat√©gorie -->
                        <div class="col-md-6 mb-3">
                            <label for="taskCategory" class="form-label fw-semibold">
                                <i class="bi bi-tags me-1 text-info"></i>
                                Cat√©gorie
                            </label>
                            <select class="form-select form-select-lg" id="taskCategory" name="category">
                                <option value="">S√©lectionner une cat√©gorie</option>
                                <option value="kitchen">üç≥ Cuisine</option>
                                <option value="service">üçΩÔ∏è Service</option>
                                <option value="inventory">üì¶ Inventaire</option>
                                <option value="cleaning">üßΩ Nettoyage</option>
                                <option value="admin">üìã Administration</option>
                                <option value="maintenance">üîß Maintenance</option>
                                <option value="training">üìö Formation</option>
                                <option value="other">üîó Autre</option>
                            </select>
                        </div>
                        
                        <!-- Date d'√©ch√©ance -->
                        <div class="col-md-6 mb-3">
                            <label for="taskDueDate" class="form-label fw-semibold">
                                <i class="bi bi-calendar-event me-1 text-success"></i>
                                Date d'√©ch√©ance
                            </label>
                            <input type="datetime-local" class="form-control form-control-lg" 
                                   id="taskDueDate" name="due_date">
                        </div>
                    </div>
                    
                    <!-- Description -->
                    <div class="mb-3">
                        <label for="taskDescription" class="form-label fw-semibold">
                            <i class="bi bi-card-text me-1 text-secondary"></i>
                            Description d√©taill√©e
                        </label>
                        <textarea class="form-control" id="taskDescription" name="description" 
                                  rows="4" maxlength="500"
                                  placeholder="D√©crivez la t√¢che en d√©tail, les √©tapes √† suivre, les ressources n√©cessaires..."></textarea>
                        <div class="form-text">
                            <small class="text-muted">
                                <span id="charCount">0</span>/500 caract√®res
                            </small>
                        </div>
                    </div>
                    
                    <div class="row">
                        <!-- Assign√© √† -->
                        <div class="col-md-6 mb-3">
                            <label for="taskAssignee" class="form-label fw-semibold">
                                <i class="bi bi-person me-1 text-primary"></i>
                                Assign√© √†
                            </label>
                            <select class="form-select form-select-lg" id="taskAssignee" name="assignee">
                                <option value="">S√©lectionner un employ√©</option>
                                <option value="me">üë§ Moi-m√™me</option>
                                <option value="chef">üë®‚Äçüç≥ Chef de cuisine</option>
                                <option value="waiter1">üçΩÔ∏è Serveur 1</option>
                                <option value="waiter2">üçΩÔ∏è Serveur 2</option>
                                <option value="cleaner">üßΩ Agent d'entretien</option>
                                <option value="manager">üëî Manager</option>
                            </select>
                        </div>
                        
                        <!-- Dur√©e estim√©e -->
                        <div class="col-md-6 mb-3">
                            <label for="taskDuration" class="form-label fw-semibold">
                                <i class="bi bi-clock me-1 text-warning"></i>
                                Dur√©e estim√©e
                            </label>
                            <select class="form-select form-select-lg" id="taskDuration" name="estimated_duration">
                                <option value="">Estimer la dur√©e</option>
                                <option value="15">15 minutes</option>
                                <option value="30">30 minutes</option>
                                <option value="60">1 heure</option>
                                <option value="120">2 heures</option>
                                <option value="240">4 heures</option>
                                <option value="480">8 heures (journ√©e compl√®te)</option>
                                <option value="custom">Dur√©e personnalis√©e</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Options additionnelles -->
                    <div class="row">
                        <div class="col-12 mb-3">
                            <div class="form-check-container">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="taskRecurring" name="is_recurring">
                                    <label class="form-check-label fw-medium" for="taskRecurring">
                                        <i class="bi bi-arrow-repeat me-1 text-info"></i>
                                        T√¢che r√©currente
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="taskUrgent" name="is_urgent">
                                    <label class="form-check-label fw-medium" for="taskUrgent">
                                        <i class="bi bi-exclamation-triangle me-1 text-danger"></i>
                                        Marquer comme urgent
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="taskNotification" name="send_notification" checked>
                                    <label class="form-check-label fw-medium" for="taskNotification">
                                        <i class="bi bi-bell me-1 text-primary"></i>
                                        Envoyer notification
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary btn-lg" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>
                    Annuler
                </button>
                <button type="submit" form="addTaskForm" class="btn btn-primary btn-lg">
                    <i class="bi bi-check-circle me-2"></i>
                    Cr√©er la t√¢che
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gestion du compteur de caract√®res
    const taskDescription = document.getElementById('taskDescription');
    const charCount = document.getElementById('charCount');
    
    if (taskDescription && charCount) {
        taskDescription.addEventListener('input', function() {
            charCount.textContent = this.value.length;
            if (this.value.length > 450) {
                charCount.className = 'text-warning fw-bold';
            } else if (this.value.length > 480) {
                charCount.className = 'text-danger fw-bold';
            } else {
                charCount.className = 'text-muted';
            }
        });
    }
    
    // Validation du formulaire
    const form = document.getElementById('addTaskForm');
    if (form) {
        form.addEventListener('submit', function(event) {
            event.preventDefault();
            
            // Validation simple
            const title = document.getElementById('taskTitle').value.trim();
            if (!title) {
                document.getElementById('taskTitle').classList.add('is-invalid');
                return;
            } else {
                document.getElementById('taskTitle').classList.remove('is-invalid');
                document.getElementById('taskTitle').classList.add('is-valid');
            }
            
            // Simulation d'ajout de t√¢che (remplacez par votre logique backend)
            console.log('Nouvelle t√¢che cr√©√©e:', {
                title: title,
                priority: document.getElementById('taskPriority').value,
                category: document.getElementById('taskCategory').value,
                description: document.getElementById('taskDescription').value,
                due_date: document.getElementById('taskDueDate').value,
                assignee: document.getElementById('taskAssignee').value,
                duration: document.getElementById('taskDuration').value,
                is_recurring: document.getElementById('taskRecurring').checked,
                is_urgent: document.getElementById('taskUrgent').checked,
                send_notification: document.getElementById('taskNotification').checked
            });
            
            // Fermer le modal avec un message de succ√®s
            const modal = bootstrap.Modal.getInstance(document.getElementById('addTaskModal'));
            modal.hide();
            
            // Afficher un toast de succ√®s (optionnel)
            showSuccessToast('T√¢che cr√©√©e avec succ√®s !');
            
            // R√©initialiser le formulaire
            form.reset();
        });
    }
    
    // Auto-fill de la date d'√©ch√©ance (aujourd'hui + 1 jour par d√©faut)
    const dueDateInput = document.getElementById('taskDueDate');
    if (dueDateInput) {
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        tomorrow.setHours(17, 0); // 17h00 par d√©faut
        dueDateInput.value = tomorrow.toISOString().slice(0, 16);
    }
});

// Fonction pour afficher un toast de succ√®s
function showSuccessToast(message) {
    // Cr√©er un toast simple
    const toastContainer = document.querySelector('.toast-container') || createToastContainer();
    
    const toastHtml = `
        <div class="toast align-items-center text-white bg-success border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="bi bi-check-circle me-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    const toastElement = toastContainer.lastElementChild;
    const toast = new bootstrap.Toast(toastElement);
    toast.show();
    
    // Supprimer le toast apr√®s fermeture
    toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
    });
}

function createToastContainer() {
    const container = document.createElement('div');
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.style.zIndex = '9999';
    document.body.appendChild(container);
    return container;
}
</script>
